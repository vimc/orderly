---
title: "Workflows"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Workflows}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

``` {r echo = FALSE, results = "hide"}
lang_output <- function(x, lang) {
  writeLines(c(sprintf("```%s", lang), x, "```"))
}
r_output <- function(x) lang_output(x, "r")
yaml_output <- function(x) lang_output(x, "yaml")
path <- orderly:::prepare_orderly_example("demo")
## Even simpler
unlink(file.path(path, "archive"), recursive = TRUE)
unlink(file.path(path, "draft"), recursive = TRUE)
unlink(file.path(path, "data"), recursive = TRUE)
unlink(file.path(path, "data"), recursive = TRUE)
remove_files <- setdiff(list.files(file.path(path, "src"), full.names = TRUE), 
                        file.path(path, "src", c("minimal", "global")))
for (file in remove_files) {
  unlink(file, recursive = TRUE)
}
unlink(file.path(path, "before.R"))
unlink(file.path(path, "source.R"))
unlink(file.path(path, "demo.yml"))
unlink(file.path(path, "README.md"))
unlink(file.path(path, "src", "README.md"))

dir_tree <- function(path) {
  withr::with_dir(path, fs::dir_tree("."))
}
```

Suppose you have a sequence of reports that you always want to run together. This might be a set of reports which you always want to run at the same time e.g. when new data comes in. Or a set of dependent reports where you want to ensure whenever one of the reports in the stack is changed the whole set of reports are re-run to create an up to date final output. Orderly workflows can help to make it easier to define and run these sets of reports together.

### Configure workflows

Workflows are defined through a yaml file in a `workflows` directory as `<workflow_name>.yml`

``` {r comment = NA, echo = FALSE}
dir_tree(path)
```

The workflow yaml contains a list of steps of reports to be run in order.
``` {r results = "asis", echo = FALSE}
yaml_output(readLines(file.path(path, "workflows", "my_workflow.yml")))
```

At the moment workflows can only be run with default parameters for each report.

### Running a workflow

To run a workflow use `orderly::orderly_workflow`

``` {r}
out <- orderly::orderly_workflow("my_workflow", root = path)
```

This returns a list of the IDs of each of the reports run as part of the workflow
```{r}
out
```

`orderly_workflow` needs to know the root of the orderly reports directory to be used. You specify this explicitly via the `root` arg or use your working directory. If your working directory is somewhere within the reports repository then you can run `orderly::orderly_workflow("workflow_name", locate = TRUE)` which will search for the root directory from your current working directory. See `?orderly::orderly_workflow` for more details.

### Additional arguments

Like `orderly::orderly_run` `orderly::orderly_workflow` exposes arguments to use alternative source databases and to resolve dependencies from a remote machine. These include `instance` (to set source db instance to be used) and `remote` (to set remote machine to resolve dependencies from). See `?orderly::orderly_workflow` for details.
