<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="orderly">
<title>orderly • orderly</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="orderly">
<meta property="og:description" content="orderly">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">orderly</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.6.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item">
  <a class="nav-link" href="../articles/orderly.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/bundles.html">orderly bundles</a>
    <a class="dropdown-item" href="../articles/changelog.html">orderly changelog</a>
    <a class="dropdown-item" href="../articles/patterns.html">orderly patterns</a>
    <a class="dropdown-item" href="../articles/remote.html">orderly remotes</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/vimc/orderly/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="orderly_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>orderly</h1>
                        <h4 data-toc-skip class="author">Rich FitzJohn</h4>
            
            <h4 data-toc-skip class="date">2023-06-21</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/vimc/orderly/blob/HEAD/vignettes/orderly.Rmd" class="external-link"><code>vignettes/orderly.Rmd</code></a></small>
      <div class="d-none name"><code>orderly.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<!-- introduction begin -->
<p><code>orderly</code> is a package designed to help make analysis more reproducible. Its principal aim is to automate a series of basic steps in the process of writing analyses, making it easy to:</p>
<ul>
<li>track all inputs into an analysis (packages, code, and data resources)</li>
<li>store multiple versions of an analysis where it is repeated</li>
<li>track outputs of an analysis</li>
<li>create analyses that depend on the outputs of previous analyses</li>
</ul>
<p>With <code>orderly</code> we have two main hopes:</p>
<ul>
<li>analysts can write code that will straightforwardly run on someone else’s machine (or a remote machine)</li>
<li>when an analysis that is run several times starts behaving differently it will be easy to see when the outputs started changing, and what inputs started changing at the same time</li>
</ul>
<p><code>orderly</code> requires a few conventions around organisation of a project, and after that tries to keep out of your way. However, these requirements are designed to make collaborative development with git easier by minimising conflicts and making backup easier by using an append-only storage system.</p>
<div class="section level3">
<h3 id="the-problem">The problem<a class="anchor" aria-label="anchor" href="#the-problem"></a>
</h3>
<p>One often-touted goal of R over point-and-click analyses packages is that if an analysis is scripted it is more reproducible. However, essentially all analyses depend on external resources - packages, data, code, and R itself; any change in these external resources might change the results. Preventing such changes in external resources is not always possible, but <em>tracking</em> changes should be straightforward - all we need to know is what is being used.</p>
<p>For example, while reproducible research <a href="https://cran.r-project.org/view=ReproducibleResearch" class="external-link">has become synonymous with literate programming</a> this approach often increases the number of external resources. A typical <a href="https://cran.r-project.org/package=knitr" class="external-link"><code>knitr</code></a> document will depend on:</p>
<ul>
<li>the source file (<code>.Rmd</code> or <code>.Rnw</code>)</li>
<li>templates used for styling</li>
<li>data that is read in for the analysis</li>
<li>code that is directly read in with <code>source</code>
</li>
</ul>
<p>The <code>orderly</code> package helps by</p>
<ul>
<li>collecting external resources before an analysis</li>
<li>ensuring that all required external resources are identified</li>
<li>removing any manual work in tracking information about these external resources</li>
<li>allowing running reports multiple times and making it easy to see what changed and why</li>
</ul>
<p>The core problem is that analyses have no general <em>interface</em>. Consider in contrast the role that functions take in programming. All functions have a set of arguments (inputs) and a return value (outputs). With <code>orderly</code>, we borrow this idea, and each piece of analysis will require that the user describes what is needed and what will be produced.</p>
</div>
<div class="section level3">
<h3 id="the-process">The process<a class="anchor" aria-label="anchor" href="#the-process"></a>
</h3>
<p>The user describes the inputs of their analysis, including:</p>
<ul>
<li>SQL queries (if using databases)</li>
<li>Required R sources</li>
<li>External resource files (e.g., csv data files, Rmd files, templates)</li>
<li>Packages required to run the analysis</li>
<li>Dependencies on previously run analyses</li>
</ul>
<p>The user also provides a list of “artefacts” (file-based results) that they will produce.</p>
<p>Then <code>orderly</code>:</p>
<ol style="list-style-type: decimal">
<li>creates a new empty directory</li>
<li>copies over <em>only</em> the declared file resources</li>
<li>loads only the declared packages</li>
<li>loads the declared R sources</li>
<li>evaluates any sql queries to create R objects</li>
<li>then runs the analysis</li>
<li>verifies that the declared artefacts are produced</li>
</ol>
<p>It then stores metadata alongside the analysis including hashes of all inputs and outputs, copies of data extracted from the database, a record of all R packages loaded at the end of the session, and (if using git) information about the git state (hash, branch and status).</p>
<p>Then if one of the dependencies of a report changes (the used data, code, etc), we have metadata that can be queried to identify the likely source of the change.</p>
<!-- introduction end -->
</div>
</div>
<div class="section level2">
<h2 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h2>
<p>To illustrate, we will start with a minimal example (you can use <code><a href="../reference/orderly_init.html">orderly::orderly_init</a></code> to create a similar structure directly), and we will build it up to demonstrate <code>orderly</code> features. In the most minimal example, we want to run a script that creates a graph. It uses no external resources.</p>
<pre><code> [01;34m. [0m
├── orderly_config.yml
└──  [01;34msrc [0m
    └──  [01;34mexample [0m
        ├── orderly.yml
        └──  [32mscript.R [0m</code></pre>
<p>In this example, the <code>orderly_config.yml</code> file is completely empty, but serves to mark the root of the <code>orderly</code> project. We have one report, called <code>example</code>, and its configuration is within <code>orderly.yml</code>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">script</span><span class="kw">:</span><span class="at"> script.R</span></span>
<span id="cb2-2"><a href="#cb2-2"></a></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="fu">artefacts</span><span class="kw">:</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">staticgraph</span><span class="kw">:</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> A graph of things</span></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="at">      </span><span class="fu">filenames</span><span class="kw">:</span><span class="at"> mygraph.png</span></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">data</span><span class="kw">:</span></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Data that went into the plot</span></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="at">      </span><span class="fu">filenames</span><span class="kw">:</span><span class="at"> mydata.csv</span></span></code></pre></div>
<p>There are two keys here:</p>
<ul>
<li>
<code>script</code> the path of the script to run, <code>script.R</code>
</li>
<li>
<code>artefacts</code> a description of the artefacts (files) that will be produced by running this script. In this case it is a graph with the filename <code>mygraph.png</code>
</li>
</ul>
<p>The script is plain R code:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.csv</a></span><span class="op">(</span><span class="va">dat</span>, <span class="st">"mydata.csv"</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/png.html" class="external-link">png</a></span><span class="op">(</span><span class="st">"mygraph.png"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The R code can be as long or as short as needed and can use whatever packages it needs. <code>orderly</code> does not do anything with the script apart from run it so it can be formatted freely (there are no magic comments, etc). There are no restrictions on what can be done except that it must produce the artefacts listed in <code>orderly.yml</code>. If not, an error will be thrown describing what was missing.</p>
<div class="section level3">
<h3 id="running-the-report">Running the report<a class="anchor" aria-label="anchor" href="#running-the-report"></a>
</h3>
<p>To run the report, use <code><a href="../reference/orderly_run.html">orderly::orderly_run</a></code> (typically one would be in the <code>orderly</code> root and so the <code>root</code> directory could be omitted, but within this vignette we use a temporary directory):</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu">orderly</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_run.html">orderly_run</a></span><span class="op">(</span><span class="st">"example"</span>, root <span class="op">=</span> <span class="va">path</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [ <span style="color: #5FAFD7; font-weight: bold;">info      </span> ]  Writing initial orderly archive version as 1.1.25</span></span></code></pre>
<pre><code><span><span class="co">## [ <span style="color: #5FAFD7; font-weight: bold;">name      </span> ]  example</span></span></code></pre>
<pre><code><span><span class="co">## [ <span style="color: #5FAFD7; font-weight: bold;">id        </span> ]  20230621-105048-bd3a2cb5</span></span></code></pre>
<pre><code><span><span class="co">## [ <span style="color: #5FAFD7; font-weight: bold;">start     </span> ]  2023-06-21 10:50:48</span></span></code></pre>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## &gt; dat &lt;- data.frame(x = 1:10, y = runif(10))</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## &gt; write.csv(dat, "mydata.csv", row.names = FALSE)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## &gt; png("mygraph.png")</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## &gt; plot(dat)</span></span></code></pre>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## &gt; dev.off()</span></span>
<span><span class="co">## agg_png </span></span>
<span><span class="co">##       2</span></span></code></pre>
<pre><code><span><span class="co">## [ <span style="color: #5FAFD7; font-weight: bold;">end       </span> ]  2023-06-21 10:50:48</span></span></code></pre>
<pre><code><span><span class="co">## [ <span style="color: #5FAFD7; font-weight: bold;">elapsed   </span> ]  Ran report in 0.0185976 secs</span></span></code></pre>
<pre><code><span><span class="co">## [ <span style="color: #5FAFD7; font-weight: bold;">artefact  </span> ]  mygraph.png: 4d7152b3aa39de3389a493eb4f2c5289</span></span>
<span><span class="co">## [ <span style="color: #5FAFD7; font-weight: bold;">...       </span> ]  mydata.csv: 51b694edbb6be70835ef9e0fbd932e01</span></span></code></pre>
<p>The return value is the id of the report (also printed on the third line of log output) and is always in the format <code>YYYYMMDD-HHMMSS-abcdef01</code> where the last 8 characters are hex digits (i.e., 4 random bytes). This means reports will automatically sort nicely but we’ll have some collision resistance.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">id</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "20230621-105048-bd3a2cb5"</span></span></code></pre>
<p>Having run the report, the directory layout now looks like:</p>
<pre><code> [01;34m. [0m
├──  [01;34marchive [0m
├──  [01;34mdraft [0m
│   └──  [01;34mexample [0m
│       └──  [01;34m20230621-105048-bd3a2cb5 [0m
│           ├── mydata.csv
│           ├──  [01;35mmygraph.png [0m
│           ├── orderly.yml
│           ├── orderly_run.rds
│           └──  [32mscript.R [0m
├── orderly_config.yml
└──  [01;34msrc [0m
    └──  [01;34mexample [0m
        ├── orderly.yml
        └──  [32mscript.R [0m</code></pre>
<p>Within <code>drafts</code>, the directory <code>example/20230621-105048-bd3a2cb5</code> has been created which contains the result of running the report. In here there are the files:</p>
<ul>
<li>
<code>orderly.yml</code>: this is an exact copy of the input file</li>
<li>
<code>script.R</code>: this is an exact copy of the script used for the analysis</li>
<li>
<code>mygraph.png</code>: the artefact created by the report</li>
<li>
<code>orderly_run.rds</code>: this is metadata about the run and includes hashes of input files, of the data used, and of the output etc, along with details about the packages used and the state of git. It is stored in R’s internal data format.</li>
</ul>
<p>Every time a report is run it will create a new directory at this level with a new id. Running the report again now might create the directory <code>example/20230621-105049-085007d6</code></p>
<p>We store the copies of files as run by <code>orderly</code> so that even if the input files change we can still easily get back to previous versions of the inputs, alongside the outputs, and these are safe from any changes to the underlying source.</p>
<p>You can see the list of draft reports like so:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">orderly</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_list_drafts.html">orderly_list_drafts</a></span><span class="op">(</span>root <span class="op">=</span> <span class="va">path</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##      name                       id</span></span>
<span><span class="co">## 1 example 20230621-105048-bd3a2cb5</span></span></code></pre>
<p>Once you’re happy with a report, then “commit” it with</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">orderly</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_commit.html">orderly_commit</a></span><span class="op">(</span><span class="va">id</span>, root <span class="op">=</span> <span class="va">path</span><span class="op">)</span></span>
<span><span class="co">## [ <span style="color: #5FAFD7; font-weight: bold;">commit    </span> ]  example/20230621-105048-bd3a2cb5</span></span>
<span><span class="co">## [ <span style="color: #5FAFD7; font-weight: bold;">copy      </span> ]</span></span>
<span><span class="co">## [ <span style="color: #5FAFD7; font-weight: bold;">import    </span> ]  example:20230621-105048-bd3a2cb5</span></span>
<span><span class="co">## [ <span style="color: #5FAFD7; font-weight: bold;">success   </span> ]  :)</span></span>
<span><span class="co">## [1] "/tmp/RtmpzlBf1Y/file3597c1dbe0b/archive/example/20230621-105048-bd3a2cb5"</span></span></code></pre></div>
<p>After this step our directory structure looks like:</p>
<pre><code> [01;34m. [0m
├──  [01;34marchive [0m
│   └──  [01;34mexample [0m
│       └──  [01;34m20230621-105048-bd3a2cb5 [0m
│           ├── mydata.csv
│           ├──  [01;35mmygraph.png [0m
│           ├── orderly.yml
│           ├── orderly_run.rds
│           └──  [32mscript.R [0m
├──  [01;34mdraft [0m
│   └──  [01;34mexample [0m
├── orderly.sqlite
├── orderly_config.yml
└──  [01;34msrc [0m
    └──  [01;34mexample [0m
        ├── orderly.yml
        └──  [32mscript.R [0m</code></pre>
<p>This looks very like the previous, but files have been moved from being within <code>draft</code> to being within <code>archive</code>. The other difference is that the index <code>orderly.sqlite</code> has been created. This is a machine-readable index to all the <code>orderly</code> metadata that can be used to build applications around <code>orderly</code> (for example <a href="https://github.com/vimc/orderly-web" class="external-link">OrderlyWeb</a>, a web portal for <code>orderly</code> - see the “remotes” vignette). The documentation for the database format is available on the <a href="https://www.vaccineimpact.org/orderly/schema/"><code>orderly</code> website</a>.</p>
</div>
</div>
<div class="section level2">
<h2 id="creating-a-report">Creating a report<a class="anchor" aria-label="anchor" href="#creating-a-report"></a>
</h2>
<p>First, run <code><a href="../reference/orderly_new.html">orderly::orderly_new</a></code> to create a directory within <code>src</code>. The name is important and should not contain spaces (nor should it change as this will change the key report id and you’ll lose a chain of history), then edit the file <code>orderly.yml</code> within that directory.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">orderly</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_new.html">orderly_new</a></span><span class="op">(</span><span class="st">"new"</span>, root <span class="op">=</span> <span class="va">path</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Created report at '/tmp/RtmpzlBf1Y/file3597c1dbe0b/src/new'</span></span></code></pre>
<pre><code><span><span class="co">## Edit the file 'orderly.yml' within this directory</span></span></code></pre>
<p>which results in a directory structure like:</p>
<pre><code> [01;34m. [0m
├──  [01;34marchive [0m
│   └──  [01;34mexample [0m
│       └──  [01;34m20230621-105048-bd3a2cb5 [0m
│           ├── mydata.csv
│           ├──  [01;35mmygraph.png [0m
│           ├── orderly.yml
│           ├── orderly_run.rds
│           └──  [32mscript.R [0m
├──  [01;34mdraft [0m
│   └──  [01;34mexample [0m
├── orderly.sqlite
├── orderly_config.yml
└──  [01;34msrc [0m
    ├──  [01;34mexample [0m
    │   ├── orderly.yml
    │   └──  [32mscript.R [0m
    └──  [01;34mnew [0m
        └── orderly.yml</code></pre>
</div>
<div class="section level2">
<h2 id="resources-sources-and-artefacts">Resources, sources and artefacts<a class="anchor" aria-label="anchor" href="#resources-sources-and-artefacts"></a>
</h2>
<p>Resources to a report are expected to be read-only files that are used by the script to produce the report. Examples of the sort of files that should be used as resources are:</p>
<ul>
<li>Moderately sized data files (large datasets should be accessed from a database),</li>
<li>A markdown file used to create a report,</li>
<li>Documentation for the report.</li>
</ul>
<p>“Resources” cannot be modified by the report; if <code>orderly</code> detects that a resource has been changed an error will be thrown.</p>
<p><code>orderly</code> will automatically detect any files named <code>README.md</code> in a report’s source directory and copy them to the new directory too.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb25-1"><a href="#cb25-1"></a><span class="fu">resources</span><span class="kw">:</span><span class="at"> </span></span>
<span id="cb25-2"><a href="#cb25-2"></a><span class="at">  </span><span class="kw">-</span><span class="at"> years.csv</span></span>
<span id="cb25-3"><a href="#cb25-3"></a><span class="at">  </span><span class="kw">-</span><span class="at"> data_dictionary.xlsx</span></span>
<span id="cb25-4"><a href="#cb25-4"></a><span class="at">  </span><span class="kw">-</span><span class="at"> report.Rmd</span></span>
<span id="cb25-5"><a href="#cb25-5"></a><span class="at">  </span><span class="kw">-</span><span class="at"> code_documentation.md</span></span></code></pre></div>
<p>“Sources” are files containing R code that will be sourced (via the R function <code><a href="https://rdrr.io/r/base/source.html" class="external-link">source()</a></code>) before the main script is run. Often this file contains functions or variables used by the main script. All of the copying and sourcing will be handled by <code>orderly</code> itself so there is no need to explicitly source the files in the main script.</p>
<p>“Artefacts” are the output of the report. At least one artefact must be listed and files created during the running of the script must be included as artefacts (or deleted before the script finishes) or an error will be returned.</p>
<p>Examples of artefacts fields in <code>orderly.yml</code>:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb26-1"><a href="#cb26-1"></a><span class="fu">artefacts</span><span class="kw">:</span></span>
<span id="cb26-2"><a href="#cb26-2"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">report</span><span class="kw">:</span></span>
<span id="cb26-3"><a href="#cb26-3"></a><span class="at">      </span><span class="fu">filenames</span><span class="kw">:</span><span class="at"> report.html</span></span>
<span id="cb26-4"><a href="#cb26-4"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> a simple report</span></span></code></pre></div>
<div class="sourceCode" id="cb27"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb27-1"><a href="#cb27-1"></a><span class="fu">artefacts</span><span class="kw">:</span></span>
<span id="cb27-2"><a href="#cb27-2"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">report</span><span class="kw">:</span></span>
<span id="cb27-3"><a href="#cb27-3"></a><span class="at">      </span><span class="fu">filenames</span><span class="kw">:</span><span class="at"> report.html</span></span>
<span id="cb27-4"><a href="#cb27-4"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> a simple report</span></span>
<span id="cb27-5"><a href="#cb27-5"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">data</span><span class="kw">:</span></span>
<span id="cb27-6"><a href="#cb27-6"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span></span>
<span id="cb27-7"><a href="#cb27-7"></a><span class="at">        </span><span class="kw">-</span><span class="at"> associated data sets</span></span>
<span id="cb27-8"><a href="#cb27-8"></a><span class="at">      </span><span class="fu">filenames</span><span class="kw">:</span></span>
<span id="cb27-9"><a href="#cb27-9"></a><span class="at">        </span><span class="kw">-</span><span class="at"> data_one.csv</span></span>
<span id="cb27-10"><a href="#cb27-10"></a><span class="at">        </span><span class="kw">-</span><span class="at"> data_two.csv</span></span>
<span id="cb27-11"><a href="#cb27-11"></a><span class="at">        </span><span class="kw">-</span><span class="at"> data_three.csv</span></span>
<span id="cb27-12"><a href="#cb27-12"></a><span class="at">        </span><span class="kw">-</span><span class="at"> data_four.csv</span></span></code></pre></div>
<p>When declaring an artefact we have to specify what format the artefact is. Currently supported formats are :<code>data</code>, <code>report</code>, <code>staticgraph</code>, <code>interactivegraph</code> and <code>interactivehtml</code>. These tags reflect the intent of use of the file, they have no special meaning within <code>orderly</code> itself.</p>
</div>
<div class="section level2">
<h2 id="using-artefacts-from-other-reports">Using artefacts from other reports<a class="anchor" aria-label="anchor" href="#using-artefacts-from-other-reports"></a>
</h2>
<p>It is often the case that we would like to write a report that depends on an earlier report, <em>e.g.</em> one report produces a large dataset and a later report produces a high level summary. <code>orderly</code> allows a report to directly copy an artefact file from an existing report without having to manually copy it into the report source directory. This is handled in the <code>depends</code> block of the report’s <code>orderly.yml</code>.</p>
<p><em>To use a file as a dependency it must be explicitly listed as an artefact.</em></p>
<p>An simple example might look like:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb28-1"><a href="#cb28-1"></a><span class="fu">depends</span><span class="kw">:</span></span>
<span id="cb28-2"><a href="#cb28-2"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">big-data-report</span><span class="kw">:</span></span>
<span id="cb28-3"><a href="#cb28-3"></a><span class="at">      </span><span class="fu">id</span><span class="kw">:</span><span class="at"> 20190425-163691-b8451bbf</span></span>
<span id="cb28-4"><a href="#cb28-4"></a><span class="at">      </span><span class="fu">use</span><span class="kw">:</span></span>
<span id="cb28-5"><a href="#cb28-5"></a><span class="at">        </span><span class="fu">data.rds</span><span class="kw">:</span><span class="at"> huge-data-set.rds</span></span></code></pre></div>
<p>This will copy the file the <code>huge-data-set.rds</code> from the report <code>big-data-report</code> with <code>id</code> <code>20190425-163691-b8451bbf</code> and rename it <code>data.rds</code>. This file can then be used by the report as if it were in the source directory.</p>
<p>If we want a report to always use the latest version of a report <code>big-data-report</code> we can set the <code>id</code> field to <code>latest</code>, <em>e.g.</em>:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb29-1"><a href="#cb29-1"></a><span class="fu">depends</span><span class="kw">:</span></span>
<span id="cb29-2"><a href="#cb29-2"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">big-data-report</span><span class="kw">:</span></span>
<span id="cb29-3"><a href="#cb29-3"></a><span class="at">      </span><span class="fu">id</span><span class="kw">:</span><span class="at"> latest</span></span>
<span id="cb29-4"><a href="#cb29-4"></a><span class="at">      </span><span class="fu">use</span><span class="kw">:</span></span>
<span id="cb29-5"><a href="#cb29-5"></a><span class="at">        </span><span class="fu">data.rds</span><span class="kw">:</span><span class="at"> huge-data-set.rds</span></span></code></pre></div>
<p>This will find the most recent version of the report <code>big-data-report</code> and copy files from that directory.</p>
<p>To use multiple artefacts from a single report add the files into the <code>use</code> block <em>e.g.</em>:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb30-1"><a href="#cb30-1"></a><span class="fu">depends</span><span class="kw">:</span></span>
<span id="cb30-2"><a href="#cb30-2"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">big-data-report</span><span class="kw">:</span></span>
<span id="cb30-3"><a href="#cb30-3"></a><span class="at">      </span><span class="fu">id</span><span class="kw">:</span><span class="at"> latest</span></span>
<span id="cb30-4"><a href="#cb30-4"></a><span class="at">      </span><span class="fu">use</span><span class="kw">:</span></span>
<span id="cb30-5"><a href="#cb30-5"></a><span class="at">        </span><span class="fu">data.rds</span><span class="kw">:</span><span class="at"> huge-data-set.rds</span></span>
<span id="cb30-6"><a href="#cb30-6"></a><span class="at">        </span><span class="fu">pop.csv</span><span class="kw">:</span><span class="at"> population_data.csv</span></span></code></pre></div>
<p>To use artefacts from multiple reports we add multiple entries to the <code>depends</code> field <em>e.g.</em>:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb31-1"><a href="#cb31-1"></a><span class="fu">depends</span><span class="kw">:</span></span>
<span id="cb31-2"><a href="#cb31-2"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">big-data-report</span><span class="kw">:</span></span>
<span id="cb31-3"><a href="#cb31-3"></a><span class="at">      </span><span class="fu">id</span><span class="kw">:</span><span class="at"> latest</span></span>
<span id="cb31-4"><a href="#cb31-4"></a><span class="at">      </span><span class="fu">use</span><span class="kw">:</span></span>
<span id="cb31-5"><a href="#cb31-5"></a><span class="at">        </span><span class="fu">data.rds</span><span class="kw">:</span><span class="at"> huge-data-set.rds</span></span>
<span id="cb31-6"><a href="#cb31-6"></a><span class="at">        </span><span class="fu">pop.csv</span><span class="kw">:</span><span class="at"> population_data.csv</span></span>
<span id="cb31-7"><a href="#cb31-7"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">report_two</span><span class="kw">:</span></span>
<span id="cb31-8"><a href="#cb31-8"></a><span class="at">      </span><span class="fu">id</span><span class="kw">:</span><span class="at"> latest</span></span>
<span id="cb31-9"><a href="#cb31-9"></a><span class="at">      </span><span class="fu">use</span><span class="kw">:</span></span>
<span id="cb31-10"><a href="#cb31-10"></a><span class="at">        </span><span class="fu">data_b.rds</span><span class="kw">:</span><span class="at"> filename.rds</span></span></code></pre></div>
<p>We can also use the same artefact from <em>different versions</em> of the same report. This might come up if we want to write a report that compares the output from different versions of another report. The yaml pattern for this is:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb32-1"><a href="#cb32-1"></a><span class="fu">depends</span><span class="kw">:</span></span>
<span id="cb32-2"><a href="#cb32-2"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">big-data-report</span><span class="kw">:</span></span>
<span id="cb32-3"><a href="#cb32-3"></a><span class="at">      </span><span class="fu">id</span><span class="kw">:</span><span class="at"> 20190425-163691-b8451bbf</span></span>
<span id="cb32-4"><a href="#cb32-4"></a><span class="at">      </span><span class="fu">use</span><span class="kw">:</span></span>
<span id="cb32-5"><a href="#cb32-5"></a><span class="at">        </span><span class="fu">data_latest.rds</span><span class="kw">:</span><span class="at"> huge-data-set.rds</span></span>
<span id="cb32-6"><a href="#cb32-6"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">big-data-report</span><span class="kw">:</span></span>
<span id="cb32-7"><a href="#cb32-7"></a><span class="at">      </span><span class="fu">id</span><span class="kw">:</span><span class="at"> 20181225-172991-34c91ef1</span></span>
<span id="cb32-8"><a href="#cb32-8"></a><span class="at">      </span><span class="fu">use</span><span class="kw">:</span></span>
<span id="cb32-9"><a href="#cb32-9"></a><span class="at">        </span><span class="fu">data_old</span><span class="kw">:</span><span class="at"> huge-data-set.rds</span></span></code></pre></div>
<p>The important feature in this example is the dashes before the report name. When all the report names are different these dashes can be omitted, but they are necessary when the report depends on different versions of the same report. Since including the dashes will never cause a problem but omitting them might, we advise that they should always be included.</p>
</div>
<div class="section level2">
<h2 id="parameterised-reports">Parameterised reports<a class="anchor" aria-label="anchor" href="#parameterised-reports"></a>
</h2>
<p>Sometimes it can be useful to control how a report runs by a parameter. This could be the name of a country that an analysis applies to (though we hope to develop a better interface for this soon) through to controlling the number of iterations that an analysis runs for. Parameters are declared in the <code>orderly.yml</code> like:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb33-1"><a href="#cb33-1"></a><span class="fu">parameters</span><span class="kw">:</span></span>
<span id="cb33-2"><a href="#cb33-2"></a><span class="at">  </span><span class="fu">a</span><span class="kw">:</span></span>
<span id="cb33-3"><a href="#cb33-3"></a><span class="at">    </span><span class="fu">default</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb33-4"><a href="#cb33-4"></a><span class="at">  </span><span class="fu">b</span><span class="kw">:</span><span class="at"> </span><span class="ch">~</span></span></code></pre></div>
<p>This would declare that a report takes two parameters <code>a</code> (with a default of 1), and <code>b</code> (with no default). Running the report would then look like:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">orderly</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_run.html">orderly_run</a></span><span class="op">(</span><span class="st">"reportname"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fl">10</span>, b <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>These parameters are then present in the environment of the report, so the code can use values <code>a</code> and <code>b</code>.</p>
<p>The parameters will also be interpolated into any SQL queries before they are run, so if the <code>orderly.yml</code> contains:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb35-1"><a href="#cb35-1"></a><span class="fu">data</span><span class="kw">:</span></span>
<span id="cb35-2"><a href="#cb35-2"></a><span class="at">  </span><span class="fu">cars</span><span class="kw">:</span></span>
<span id="cb35-3"><a href="#cb35-3"></a><span class="at">    </span><span class="fu">query</span><span class="kw">:</span><span class="at"> SELECT * FROM mtcars WHERE cyl &gt; ?a</span></span></code></pre></div>
<p>then this will be evaluated on the SQL server with <code>a</code> substituted in where the query says <code>?a</code> (this is done with <code><a href="https://dbi.r-dbi.org/reference/sqlInterpolate.html" class="external-link">DBI::sqlInterpolate</a></code>).</p>
</div>
<div class="section level2">
<h2 id="using-global-resources">Using global resources<a class="anchor" aria-label="anchor" href="#using-global-resources"></a>
</h2>
<p>There might be files that are used in (almost) every report. Examples of these sorts of files might be document templates or organisation logos. To set up a global resource create a directory <code>your_global_dir</code> in <code>&lt;root&gt;</code> and the following to the <code>orderly_config.yml</code>:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb36-1"><a href="#cb36-1"></a><span class="fu">global_resources</span><span class="kw">:</span></span>
<span id="cb36-2"><a href="#cb36-2"></a><span class="at">  your_global_dir</span></span></code></pre></div>
<p>Then to use any file in <code>your_global_dir</code> in your report add a <code>global_resources</code> field to that report’s <code>orderly.yml</code>:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb37-1"><a href="#cb37-1"></a><span class="fu">global_resources</span><span class="kw">:</span></span>
<span id="cb37-2"><a href="#cb37-2"></a><span class="at">  </span><span class="fu">logo.jpg</span><span class="kw">:</span><span class="at"> org_logo.jpg</span></span>
<span id="cb37-3"><a href="#cb37-3"></a><span class="at">  </span><span class="fu">latex_class.cls</span><span class="kw">:</span><span class="at"> org_latex_class.cls</span></span>
<span id="cb37-4"><a href="#cb37-4"></a><span class="at">  </span><span class="fu">styles.css</span><span class="kw">:</span><span class="at"> org_styles.css</span></span></code></pre></div>
<p>Currently code <em>i.e.</em> R source code cannot be sourced from the global resources directory. So for example utility functions common across multiple reports must be included in each report directory separately. The functionality to include global source code may be added in future versions.</p>
</div>
<div class="section level2">
<h2 id="using-version-control">Using version control<a class="anchor" aria-label="anchor" href="#using-version-control"></a>
</h2>
<p><code>orderly</code> is designed to work well with <a href="https://git-scm.com/" class="external-link">git</a> (or any other version control system). The general principle is that <code>src/</code> and any configuration files should be added to git, while most of the generated files (<code>data</code>, <code>draft</code>, <code>archive</code>, and any SQLite databases such as <code>orderly.sqlite</code>) should be excluded, which can be done by creating a <code>.gitignore</code> file.</p>
<p>This process can be automated by running</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">orderly</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_use.html">orderly_use_gitignore</a></span><span class="op">(</span>root <span class="op">=</span> <span class="va">path</span>, prompt <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Changes to '/tmp/RtmpzlBf1Y/file3597c1dbe0b/.gitignore'</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #B2B2B2; font-weight: bold;"> 1</span> | <span style="font-weight: bold;"># These are directories where orderly stores (potentially large)</span></span></span>
<span><span class="co">## <span style="color: #B2B2B2; font-weight: bold;"> 2</span> | <span style="font-weight: bold;"># generated files - you definitely do not want these in git.</span></span></span>
<span><span class="co">## <span style="color: #B2B2B2; font-weight: bold;"> 3</span> | <span style="font-weight: bold;">data</span></span></span>
<span><span class="co">## <span style="color: #B2B2B2; font-weight: bold;"> 4</span> | <span style="font-weight: bold;">archive</span></span></span>
<span><span class="co">## <span style="color: #B2B2B2; font-weight: bold;"> 5</span> | <span style="font-weight: bold;">draft</span></span></span>
<span><span class="co">## <span style="color: #B2B2B2; font-weight: bold;"> 6</span> | <span style="font-weight: bold;">metadata</span></span></span>
<span><span class="co">## <span style="color: #B2B2B2; font-weight: bold;"> 7</span> | </span></span>
<span><span class="co">## <span style="color: #B2B2B2; font-weight: bold;"> 8</span> | <span style="font-weight: bold;"># Orderly will store data in a sqlite database, by default orderly.sqlite</span></span></span>
<span><span class="co">## <span style="color: #B2B2B2; font-weight: bold;"> 9</span> | <span style="font-weight: bold;">*.sqlite</span></span></span>
<span><span class="co">## <span style="color: #B2B2B2; font-weight: bold;">10</span> | </span></span>
<span><span class="co">## <span style="color: #B2B2B2; font-weight: bold;">11</span> | <span style="font-weight: bold;"># It is suggested to use environment variables, in either</span></span></span>
<span><span class="co">## <span style="color: #B2B2B2; font-weight: bold;">12</span> | <span style="font-weight: bold;"># orderly_envir.yml or .Renviron to store sensitive data to use with</span></span></span>
<span><span class="co">## <span style="color: #B2B2B2; font-weight: bold;">13</span> | <span style="font-weight: bold;"># orderly - keep those out of git</span></span></span>
<span><span class="co">## <span style="color: #B2B2B2; font-weight: bold;">14</span> | <span style="font-weight: bold;">.Renviron</span></span></span>
<span><span class="co">## <span style="color: #B2B2B2; font-weight: bold;">15</span> | <span style="font-weight: bold;">orderly_envir.yml</span></span></span>
<span><span class="co">## <span style="color: #B2B2B2; font-weight: bold;">16</span> | </span></span>
<span><span class="co">## <span style="color: #B2B2B2; font-weight: bold;">17</span> | <span style="font-weight: bold;"># Other good things to exclude</span></span></span>
<span><span class="co">## <span style="color: #B2B2B2; font-weight: bold;">18</span> | <span style="font-weight: bold;">.Rhistory</span></span></span>
<span><span class="co">## <span style="color: #B2B2B2; font-weight: bold;">19</span> | <span style="font-weight: bold;">.Rdata</span></span></span>
<span><span class="co">## <span style="color: #B2B2B2; font-weight: bold;">20</span> | <span style="font-weight: bold;">.Rproj.user</span></span></span>
<span><span class="co">## <span style="color: #B2B2B2; font-weight: bold;">21</span> | </span></span>
<span><span class="co">## <span style="color: #B2B2B2; font-weight: bold;">22</span> | <span style="font-weight: bold;"># Created by orderly.server</span></span></span>
<span><span class="co">## <span style="color: #B2B2B2; font-weight: bold;">23</span> | <span style="font-weight: bold;">runner</span></span></span>
<span><span class="co">## <span style="color: #B2B2B2; font-weight: bold;">24</span> | <span style="font-weight: bold;">backup</span></span></span></code></pre>
<pre><code><span><span class="co">## Writing to '/tmp/RtmpzlBf1Y/file3597c1dbe0b/.gitignore'</span></span></code></pre>
<p>(the default, <code>prompt = TRUE</code> will request user confirmation before writing the <code>.gitignore</code> file).</p>
<p>You should arrange to back up the entire orderly directory through some other means.</p>
<p>If your generated files are particularly small you might leave them in git, but in our experience this will result in a git repository that is unpleasant to use.</p>
</div>
<div class="section level2">
<h2 id="using-sql-databases">Using SQL databases<a class="anchor" aria-label="anchor" href="#using-sql-databases"></a>
</h2>
<p>One of the original aims of <code>orderly</code> was to provide a set of tools for use of SQL databases within reproducible reporting. Because the SQL database is an external global resource it is difficult to work with any concept of “versioning” from R (there is no git history, no way of easily rolling back to previous versions etc). If using a central SQL server, there is configuration that should be kept <em>out</em> of any analysis, particularly things like passwords. Configuration problems multiply when using both “production” and “staging” systems as we would like to be able to switch between different configurations.</p>
<div class="section level3">
<h3 id="configuration">Configuration<a class="anchor" aria-label="anchor" href="#configuration"></a>
</h3>
<p>The root <code>orderly_config.yml</code> configuration specifies the locations of databases (there can be any number), for example:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb42-1"><a href="#cb42-1"></a><span class="fu">database</span><span class="kw">:</span></span>
<span id="cb42-2"><a href="#cb42-2"></a><span class="at">  </span><span class="fu">source</span><span class="kw">:</span></span>
<span id="cb42-3"><a href="#cb42-3"></a><span class="at">    </span><span class="fu">driver</span><span class="kw">:</span><span class="at"> RPostgres::Postgres</span></span>
<span id="cb42-4"><a href="#cb42-4"></a><span class="at">    </span><span class="fu">args</span><span class="kw">:</span></span>
<span id="cb42-5"><a href="#cb42-5"></a><span class="at">      </span><span class="fu">host</span><span class="kw">:</span><span class="at"> dbhost.example.org</span></span>
<span id="cb42-6"><a href="#cb42-6"></a><span class="at">      </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">5432</span></span>
<span id="cb42-7"><a href="#cb42-7"></a><span class="at">      </span><span class="fu">user</span><span class="kw">:</span><span class="at"> myusername</span></span>
<span id="cb42-8"><a href="#cb42-8"></a><span class="at">      </span><span class="fu">password</span><span class="kw">:</span><span class="at"> s3cret</span></span>
<span id="cb42-9"><a href="#cb42-9"></a><span class="at">      </span><span class="fu">dbname</span><span class="kw">:</span><span class="at"> mydb</span></span></code></pre></div>
<p>This database will be referred to elsewhere as <code>source</code> and it will be connected with the <code><a href="https://rpostgres.r-dbi.org/reference/Postgres.html" class="external-link">RPostgres::Postgres</a></code> driver (from the <a href="https://cran.r-project.org/package=RPostgres" class="external-link">RPostgres</a> package). Arguments within the <code>args</code> block will be passed to the driver, in this case being the equivalent of:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="fu">RPostgres</span><span class="fu">::</span><span class="va"><a href="https://rpostgres.r-dbi.org/reference/Postgres.html" class="external-link">Postgres</a></span>, host <span class="op">=</span> <span class="st">"dbhost.example.org"</span>, port <span class="op">=</span> <span class="fl">5432</span>,</span>
<span>               user <span class="op">=</span> <span class="st">"myusername"</span>, password <span class="op">=</span> <span class="st">"s3cret"</span>, dbname <span class="op">=</span> <span class="st">"mydb"</span><span class="op">)</span></span></code></pre></div>
<p>The values used in the <code>args</code> blocks can be environment values (e.g., <code>password: $DB_PASSWORD</code>) in which case they will be resolved from the environment before connecting. This will be useful for keeping secrets out of source control.</p>
<p>For <a href="https://cran.r-project.org/package=RSQLite" class="external-link">SQLite</a> databases, the <code>args</code> block will typically contain only <code>dbname</code> which is the path to the database file.</p>
</div>
<div class="section level3">
<h3 id="use-within-a-report">Use within a report<a class="anchor" aria-label="anchor" href="#use-within-a-report"></a>
</h3>
<p>A report configuration (<code>orderly.yml</code>) can contain a <code>data</code> block, which contains sql queries, such as:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb44-1"><a href="#cb44-1"></a><span class="fu">data</span><span class="kw">:</span></span>
<span id="cb44-2"><a href="#cb44-2"></a><span class="at">  </span><span class="fu">cars</span><span class="kw">:</span></span>
<span id="cb44-3"><a href="#cb44-3"></a><span class="at">    </span><span class="fu">query</span><span class="kw">:</span><span class="at"> SELECT * FROM mtcars WHERE cyl = 4</span></span>
<span id="cb44-4"><a href="#cb44-4"></a><span class="at">    </span><span class="fu">database</span><span class="kw">:</span><span class="at"> source</span></span></code></pre></div>
<p>In this case, the query <code>SELECT * FROM mtcars WHERE cyl = 4</code> will be run against the <code>source</code> database to create an object <code>cars</code> in the report environment. The actual report code can use that object without having ever created the database connection or evaluating the query.</p>
<p>Further, the data used in the query will be captured in <code>orderly</code>’s <code>data</code> directory, and hashes of the data will be stored alongside the results. This means that even if the data in the database is a constantly moving target we can still detect if changes to the data are responsible for changes in the result of a report.</p>
</div>
<div class="section level3">
<h3 id="advanced-use">Advanced use<a class="anchor" aria-label="anchor" href="#advanced-use"></a>
</h3>
<p>If you need to perform complicated SQL queries, then you can export the database connection directly by adding a block:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb45-1"><a href="#cb45-1"></a><span class="fu">connection</span><span class="kw">:</span></span>
<span id="cb45-2"><a href="#cb45-2"></a><span class="at">  </span><span class="fu">con</span><span class="kw">:</span><span class="at"> source</span></span></code></pre></div>
<p>which will save the connection to the <code>source</code> database as the R object <code>con</code>. We have used this where a report requires running queries in a loop that depend on the results of a previous query or additional data loaded into a report, or where the result of the query will be very large and we do not want to save it to disk.</p>
<p>Note that this reduces the amount of tracking that <code>orderly</code> can do, as we have no way of knowing what is done with the connection once passed to the script.</p>
</div>
<div class="section level3">
<h3 id="customising-the-database-configuration">Customising the database configuration<a class="anchor" aria-label="anchor" href="#customising-the-database-configuration"></a>
</h3>
<p>The contents of <code>orderly_config.yml</code> may contain things like secrets (passwords) or hostnames that vary depending on deployment (e.g., testing locally vs running on a remote system). To customise this, you can use environment variables within the configuration. So rather than writing</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb46-1"><a href="#cb46-1"></a><span class="fu">database</span><span class="kw">:</span></span>
<span id="cb46-2"><a href="#cb46-2"></a><span class="at">  </span><span class="fu">source</span><span class="kw">:</span></span>
<span id="cb46-3"><a href="#cb46-3"></a><span class="at">    </span><span class="fu">driver</span><span class="kw">:</span><span class="at"> RPostgres::Postgres</span></span>
<span id="cb46-4"><a href="#cb46-4"></a><span class="at">    </span><span class="fu">args</span><span class="kw">:</span></span>
<span id="cb46-5"><a href="#cb46-5"></a><span class="at">      </span><span class="fu">host</span><span class="kw">:</span><span class="at"> localhost</span></span>
<span id="cb46-6"><a href="#cb46-6"></a><span class="at">      </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">5432</span></span>
<span id="cb46-7"><a href="#cb46-7"></a><span class="at">      </span><span class="fu">user</span><span class="kw">:</span><span class="at"> myuser</span></span>
<span id="cb46-8"><a href="#cb46-8"></a><span class="at">      </span><span class="fu">dbname</span><span class="kw">:</span><span class="at"> databasename</span></span>
<span id="cb46-9"><a href="#cb46-9"></a><span class="at">      </span><span class="fu">password</span><span class="kw">:</span><span class="at"> p4ssw0rd</span></span></code></pre></div>
<p>you might write</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb47-1"><a href="#cb47-1"></a><span class="fu">database</span><span class="kw">:</span></span>
<span id="cb47-2"><a href="#cb47-2"></a><span class="at">  </span><span class="fu">source</span><span class="kw">:</span></span>
<span id="cb47-3"><a href="#cb47-3"></a><span class="at">    </span><span class="fu">driver</span><span class="kw">:</span><span class="at"> RPostgres::Postgres</span></span>
<span id="cb47-4"><a href="#cb47-4"></a><span class="at">    </span><span class="fu">args</span><span class="kw">:</span></span>
<span id="cb47-5"><a href="#cb47-5"></a><span class="at">      </span><span class="fu">host</span><span class="kw">:</span><span class="at"> $MY_DBHOST</span></span>
<span id="cb47-6"><a href="#cb47-6"></a><span class="at">      </span><span class="fu">port</span><span class="kw">:</span><span class="at"> $MY_DBPORT</span></span>
<span id="cb47-7"><a href="#cb47-7"></a><span class="at">      </span><span class="fu">user</span><span class="kw">:</span><span class="at"> $MY_DBUSER</span></span>
<span id="cb47-8"><a href="#cb47-8"></a><span class="at">      </span><span class="fu">dbname</span><span class="kw">:</span><span class="at"> $MY_DBNAME</span></span>
<span id="cb47-9"><a href="#cb47-9"></a><span class="at">      </span><span class="fu">password</span><span class="kw">:</span><span class="at"> $MY_PASSWORD</span></span></code></pre></div>
<p>environment variables, as used this way <strong>must</strong> begin with a dollar sign and consist only of uppercase letters, numbers and the underscore character. You can then set the environment variables in an <code>.Renviron</code> (either within the project or in your home directory) file or your <code>.profile</code> file. Alternatively, you can create a file <code>orderly_envir.yml</code> in the same directory as <code>orderly_config.yml</code> with key-value pairs, such as</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb48-1"><a href="#cb48-1"></a><span class="fu">MY_DBHOST</span><span class="kw">:</span><span class="at"> localhost</span></span>
<span id="cb48-2"><a href="#cb48-2"></a><span class="fu">MY_DBPORT</span><span class="kw">:</span><span class="at"> </span><span class="dv">5432</span></span>
<span id="cb48-3"><a href="#cb48-3"></a><span class="fu">MY_DBUSER</span><span class="kw">:</span><span class="at"> myuser</span></span>
<span id="cb48-4"><a href="#cb48-4"></a><span class="fu">MY_DBNAME</span><span class="kw">:</span><span class="at"> databasename</span></span>
<span id="cb48-5"><a href="#cb48-5"></a><span class="fu">MY_PASSWORD</span><span class="kw">:</span><span class="at"> p4ssw0rd</span></span></code></pre></div>
<p>This will be read every time that <code>orderly_config.yml</code> is read (in contrast with <code>.Renviron</code> which is read-only at the start of a session). This will likely be more pleasant to work with.</p>
<p>The advantage of using environment variables is that you can add the <code>orderly_envir.yml</code> file to your <code>.gitignore</code> and avoid committing system-dependent data to the central repository (see <code><a href="../reference/orderly_use.html">orderly::orderly_use_gitignore</a></code>) to help automate this.</p>
<p>To avoid leaving passwords in plain text, you can use <a href="https://www.vaultproject.io" class="external-link"><code>vault</code></a> (along with the R client <a href="https://cran.r-project.org/package=vaultr" class="external-link"><code>vaultr</code></a>) to retrieve them.</p>
<p>To do this, you should include the address of your vault server in the <code>orderly_config.yml</code> as</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb49-1"><a href="#cb49-1"></a><span class="fu">vault</span><span class="kw">:</span></span>
<span id="cb49-2"><a href="#cb49-2"></a><span class="at">  </span><span class="fu">addr</span><span class="kw">:</span><span class="at"> https://example.com:8200</span></span></code></pre></div>
<p>Then, for values that you want to retrieve from the vault, set the value of the field to <code>VAULT:&lt;path&gt;:&lt;field&gt;</code>, where <code>&lt;path&gt;</code> is the name of a vault secret path (probably beginning with <code>/secret/</code> and <code>field</code> is the name of the field at that path. So, for example:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb50-1"><a href="#cb50-1"></a><span class="at">      </span><span class="fu">password</span><span class="kw">:</span><span class="at"> VAULT:/secret/users/database_user:password</span></span></code></pre></div>
<p>would look up the field <code>password</code> at the path <code>/secret/users/database_user</code>. This can be stored in <code>orderly_config.yml</code>, in the contents of an environment variable or in <code>orderly_envir.yml</code> (currently this only uses the vault <a href="https://www.vaultproject.io/docs/secrets/kv/kv-v1.html" class="external-link">version 1 key-value storage</a>)</p>
<p>If you need to control how the vault server is accessed, then you can pass additional arguments within an <code>args</code> block:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb51-1"><a href="#cb51-1"></a><span class="fu">vault</span><span class="kw">:</span></span>
<span id="cb51-2"><a href="#cb51-2"></a><span class="at">  </span><span class="fu">addr</span><span class="kw">:</span><span class="at"> https://example.com:8200</span></span>
<span id="cb51-3"><a href="#cb51-3"></a><span class="at">  </span><span class="fu">login</span><span class="kw">:</span><span class="at"> userpass</span></span>
<span id="cb51-4"><a href="#cb51-4"></a><span class="at">  </span><span class="fu">username</span><span class="kw">:</span><span class="at"> alice</span></span>
<span id="cb51-5"><a href="#cb51-5"></a><span class="at">  </span><span class="fu">password</span><span class="kw">:</span><span class="at"> secret</span></span>
<span id="cb51-6"><a href="#cb51-6"></a><span class="at">  </span><span class="fu">mount</span><span class="kw">:</span><span class="at"> userpass</span></span></code></pre></div>
<p>This is equivalent to connecting to the vault, using <code>vaultr</code> as</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">vaultr</span><span class="fu">::</span><span class="fu">vault_client</span><span class="op">(</span>addr <span class="op">=</span> <span class="st">"https://example.com:8200"</span>, login <span class="op">=</span> <span class="st">"userpass"</span>,</span>
<span>                     username <span class="op">=</span> <span class="st">"alice"</span>, password <span class="op">=</span> <span class="st">"secret"</span>,</span>
<span>                     mount <span class="op">=</span> <span class="st">"userpass"</span><span class="op">)</span></span></code></pre></div>
<p>Environment variables here will be respected so you could write:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb53-1"><a href="#cb53-1"></a><span class="fu">vault</span><span class="kw">:</span></span>
<span id="cb53-2"><a href="#cb53-2"></a><span class="at">  </span><span class="fu">addr</span><span class="kw">:</span><span class="at"> https://example.com:8200</span></span>
<span id="cb53-3"><a href="#cb53-3"></a><span class="at">  </span><span class="fu">login</span><span class="kw">:</span><span class="at"> userpass</span></span>
<span id="cb53-4"><a href="#cb53-4"></a><span class="at">  </span><span class="fu">username</span><span class="kw">:</span><span class="at"> $VAULT_USER</span></span>
<span id="cb53-5"><a href="#cb53-5"></a><span class="at">  </span><span class="fu">password</span><span class="kw">:</span><span class="at"> $VAULT_PASSWORD</span></span></code></pre></div>
<p>and the username and password will be found from environment variables (the actual secret resolution uses <code>vaultr::vault_resolve_secrets</code> - see the documentation in <code>vaultr</code> for further details).</p>
</div>
<div class="section level3">
<h3 id="advanced-database-configuration">Advanced database configuration<a class="anchor" aria-label="anchor" href="#advanced-database-configuration"></a>
</h3>
<p><em>In general, you can ignore this section if you only use one global database.</em></p>
<p>The above approach can be used to switch databases by using different environmental variables, but that can become tiresome. If you have multiple database “instances” corresponding to different realisations of the same logical database (e.g., production and staging), then you can configure and switch between these directly from <code>orderly</code> commands. At <a href="https://www.vaccineimpact.org" class="external-link">VIMC</a> we have several copies of our main database: one called <code>production</code>, which is the canonical copy, and then several <code>staging</code> copies that we use for experimentation.</p>
<p>To configure this situation, list common arguments within the <code>args</code> block as before, then add logical databases as named entries in an <code>instances</code> field:</p>
<pre><code>database:
  source:
    driver: RPostgres::Postgres
    args:
      port: 5432
      user: user
      dbname: mydb
    instances:
      production:
        host: production.example.org
        password: $PASSWORD_PRODUCTION
      staging:
        host: staging.example.org
        password: $PASSWORD_STAGING
    default_instance: $DEFAULT_INSTANCE</code></pre>
<p>Here - staging and production have different hostnames (<code>production.example.org</code> and <code>staging.example.org</code>) and different passwords (retrieved using environment variables) and the default instance is set with another environment variable (<code>$DEFAULT_INSTANCE</code>, which must be one of <code>production</code> or <code>staging</code>). To switch between databases, you can set that variable, or pass the <code>instance</code> argument to <code><a href="../reference/orderly_run.html">orderly::orderly_run</a></code> and friends, as:</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">orderly</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_run.html">orderly_run</a></span><span class="op">(</span><span class="va">name</span>, instance <span class="op">=</span> <span class="st">"production"</span><span class="op">)</span></span></code></pre></div>
<p>or</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">orderly</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_run.html">orderly_run</a></span><span class="op">(</span><span class="va">name</span>, instance <span class="op">=</span> <span class="st">"staging"</span><span class="op">)</span></span></code></pre></div>
<p>If there is more than one database configured, then the interpretation of <code>instance</code> is a little more nuanced. For example, suppose we have this (abridged) database configuration:</p>
<pre><code><span><span class="va">database</span><span class="op">:</span></span>
<span>  <span class="va">source</span><span class="op">:</span></span>
<span>    <span class="va">driver</span><span class="op">:</span> <span class="fu">RPostgres</span><span class="fu">::</span><span class="va"><a href="https://rpostgres.r-dbi.org/reference/Postgres.html" class="external-link">Postgres</a></span></span>
<span>    <span class="va">args</span><span class="op">:</span></span>
<span>      <span class="va">port</span><span class="op">:</span> <span class="fl">5432</span></span>
<span>    <span class="va">instances</span><span class="op">:</span></span>
<span>      <span class="va">production</span><span class="op">:</span></span>
<span>        <span class="va">host</span><span class="op">:</span> <span class="va">production.example.org</span></span>
<span>      <span class="va">staging</span><span class="op">:</span></span>
<span>        <span class="va">host</span><span class="op">:</span> <span class="va">staging.example.org</span></span>
<span>    <span class="va">default_instance</span><span class="op">:</span> <span class="va">staging</span></span>
<span>  <span class="va">extra</span><span class="op">:</span></span>
<span>    <span class="va">driver</span><span class="op">:</span> <span class="fu">RPostgres</span><span class="fu">::</span><span class="va"><a href="https://rpostgres.r-dbi.org/reference/Postgres.html" class="external-link">Postgres</a></span></span>
<span>    <span class="va">args</span><span class="op">:</span></span>
<span>      <span class="va">port</span><span class="op">:</span> <span class="fl">5432</span></span>
<span>      <span class="va">host</span><span class="op">:</span> <span class="va">extra.example.org</span></span></code></pre>
<p>Then we can pass in a string like <code>production</code> in as the instance, e.g.,</p>
<pre><code><span><span class="fu">orderly</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_run.html">orderly_run</a></span><span class="op">(</span><span class="va">name</span>, instance <span class="op">=</span> <span class="st">"production"</span><span class="op">)</span></span></code></pre>
<p>as the <code>source</code> database will select the <code>production</code> instance and as there are no instances configured for the <code>extra</code> database we will ignore the argument when connecting to <code>extra</code>.</p>
<p>However, if <em>both</em> databases had two instances, such as:</p>
<pre><code><span><span class="va">database</span><span class="op">:</span></span>
<span>  <span class="va">source</span><span class="op">:</span></span>
<span>    <span class="va">driver</span><span class="op">:</span> <span class="fu">RPostgres</span><span class="fu">::</span><span class="va"><a href="https://rpostgres.r-dbi.org/reference/Postgres.html" class="external-link">Postgres</a></span></span>
<span>    <span class="va">args</span><span class="op">:</span></span>
<span>      <span class="va">port</span><span class="op">:</span> <span class="fl">5432</span></span>
<span>    <span class="va">instances</span><span class="op">:</span></span>
<span>      <span class="va">production</span><span class="op">:</span></span>
<span>        <span class="va">host</span><span class="op">:</span> <span class="va">production.example.org</span></span>
<span>      <span class="va">staging</span><span class="op">:</span></span>
<span>        <span class="va">host</span><span class="op">:</span> <span class="va">staging.example.org</span></span>
<span>    <span class="va">default_instance</span><span class="op">:</span> <span class="va">staging</span></span>
<span>  <span class="va">extra</span><span class="op">:</span></span>
<span>    <span class="va">driver</span><span class="op">:</span> <span class="fu">RPostgres</span><span class="fu">::</span><span class="va"><a href="https://rpostgres.r-dbi.org/reference/Postgres.html" class="external-link">Postgres</a></span></span>
<span>    <span class="va">args</span><span class="op">:</span></span>
<span>      <span class="va">port</span><span class="op">:</span> <span class="fl">15432</span></span>
<span>    <span class="va">instances</span><span class="op">:</span></span>
<span>      <span class="va">production</span><span class="op">:</span></span>
<span>        <span class="va">host</span><span class="op">:</span> <span class="va">production.example.org</span></span>
<span>      <span class="va">staging</span><span class="op">:</span></span>
<span>        <span class="va">host</span><span class="op">:</span> <span class="va">staging.example.org</span></span>
<span>    <span class="va">default_instance</span><span class="op">:</span> <span class="va">staging</span></span></code></pre>
<p>Then it is possible to select <em>different</em> instances for each database, such as:</p>
<pre><code><span><span class="fu">orderly</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_run.html">orderly_run</a></span><span class="op">(</span><span class="va">name</span>,</span>
<span>                      instance <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>source <span class="op">=</span> <span class="st">"production"</span>, extra <span class="op">=</span> <span class="st">"staging"</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="using-environment-variables-and-secrets">Using environment variables and secrets<a class="anchor" aria-label="anchor" href="#using-environment-variables-and-secrets"></a>
</h2>
<p>Environment variables declared in <code>orderly.yml</code> are made available in the report script (since orderly 1.1.11). For example, if your <code>orderly.yml</code> contains</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb61-1"><a href="#cb61-1"></a><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb61-2"><a href="#cb61-2"></a><span class="at">  </span><span class="fu">external_file</span><span class="kw">:</span><span class="at"> EXTERNAL_FILE_PATH</span></span>
<span id="cb61-3"><a href="#cb61-3"></a><span class="at">  </span><span class="fu">variable_2</span><span class="kw">:</span><span class="at"> ENV_VAR_2</span></span></code></pre></div>
<p>Then orderly will evaluate the variables and make them available in your script via the specified name. For example in your script you can use</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">external_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">external_file</span><span class="op">)</span></span></code></pre></div>
<p>The expected use case for this is if you have data which you want to use in a report but do not want to be in the orderly repository (either because it is sensitive or particularly large). You can have the external files somewhere else on your machine and specify the path to them via an environment variable so they can then be accessed from the report script.</p>
<p>Environment variables can also be used in top-level <code>orderly_envir.yml</code> (since orderly 1.1.6) which can be accessed via <code><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv()</a></code>. For example, if your <code>orderly_envir.yml</code> contains</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb63-1"><a href="#cb63-1"></a><span class="fu">DATA_URL</span><span class="kw">:</span><span class="at"> https://www.example.com/thedata</span></span></code></pre></div>
<p>Then in your script you can use</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">url</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"DATA_URL"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span><span class="va">url</span><span class="op">)</span></span></code></pre></div>
<p>If the values are sensitive, then this is not ideal, as you will store your values in plain text in the <code>orderly_envir.yml</code>. Instead, if using vault, you can use a <code>secrets:</code> section in <code>orderly.yml</code>, like:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb65-1"><a href="#cb65-1"></a><span class="fu">secrets</span><span class="kw">:</span></span>
<span id="cb65-2"><a href="#cb65-2"></a><span class="at">  </span><span class="fu">password</span><span class="kw">:</span><span class="at"> /secret/myproject/login:value</span></span></code></pre></div>
<p>and then an R variable <code>password</code> will be available to all the code in your report, containing the result of looking up <code>/secret/myproject/login</code> in your vault and getting the <code>value</code> field.</p>
</div>
<div class="section level2">
<h2 id="developing-a-report">Developing a report<a class="anchor" aria-label="anchor" href="#developing-a-report"></a>
</h2>
<p>Because orderly works in a directory that is not the same as the source directory (e.g., <code>draft/myreport/YYYYMMDD-HHMMSS-abcdefgh</code>), because global resources and dependencies etc are copied in just as it is used, and because <code>orderly</code> takes control of things like parameters and sourcing files, it may not seem straightforward to develop a report as you would ordinarily.</p>
<p>In order to make this easier, orderly has a set of functions to help develop a report within the source directory. These functions are:</p>
<ul>
<li>
<code><a href="../reference/orderly_develop_start.html">orderly::orderly_develop_start</a></code> which copies files <em>into</em> your source copy</li>
<li>
<code><a href="../reference/orderly_develop_start.html">orderly::orderly_develop_status</a></code> which reports on the status of your source</li>
<li>
<code><a href="../reference/orderly_develop_start.html">orderly::orderly_develop_clean</a></code> which cleans up files that orderly copied</li>
</ul>
<p>This section illustrates the idea, creating a new report that will depend on an artefact from a previous report. Here is the state of our orderly tree from before:</p>
<pre><code> [01;34m. [0m
├──  [01;34marchive [0m
│   └──  [01;34mexample [0m
│       └──  [01;34m20230621-105048-bd3a2cb5 [0m
│           ├── mydata.csv
│           ├──  [01;35mmygraph.png [0m
│           ├── orderly.yml
│           ├── orderly_run.rds
│           └──  [32mscript.R [0m
├──  [01;34mdraft [0m
│   └──  [01;34mexample [0m
├── orderly.sqlite
├── orderly_config.yml
└──  [01;34msrc [0m
    ├──  [01;34mexample [0m
    │   ├── orderly.yml
    │   └──  [32mscript.R [0m
    └──  [01;34mnew [0m
        ├── orderly.yml
        └──  [32mscript.R [0m</code></pre>
<p>The new report has an <code>orderly.yml</code> containing</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb67-1"><a href="#cb67-1"></a><span class="fu">script</span><span class="kw">:</span><span class="at"> script.R</span></span>
<span id="cb67-2"><a href="#cb67-2"></a></span>
<span id="cb67-3"><a href="#cb67-3"></a><span class="fu">artefacts</span><span class="kw">:</span></span>
<span id="cb67-4"><a href="#cb67-4"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">staticgraph</span><span class="kw">:</span></span>
<span id="cb67-5"><a href="#cb67-5"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Mean of the values</span></span>
<span id="cb67-6"><a href="#cb67-6"></a><span class="at">      </span><span class="fu">filenames</span><span class="kw">:</span><span class="at"> mean.txt</span></span>
<span id="cb67-7"><a href="#cb67-7"></a></span>
<span id="cb67-8"><a href="#cb67-8"></a><span class="fu">depends</span><span class="kw">:</span></span>
<span id="cb67-9"><a href="#cb67-9"></a><span class="at">  </span><span class="fu">example</span><span class="kw">:</span></span>
<span id="cb67-10"><a href="#cb67-10"></a><span class="at">    </span><span class="fu">id</span><span class="kw">:</span><span class="at"> latest</span></span>
<span id="cb67-11"><a href="#cb67-11"></a><span class="at">    </span><span class="fu">use</span><span class="kw">:</span></span>
<span id="cb67-12"><a href="#cb67-12"></a><span class="at">      </span><span class="fu">data.csv</span><span class="kw">:</span><span class="at"> mydata.csv</span></span></code></pre></div>
<p>In order to run this report, we need the file <code>data.csv</code> (which contains the output <code>mydata.csv</code> from the latest version of the <code>example</code> report) to exist. If we wanted to interactively develop the <code>script.R</code> we’d have to run <code><a href="../reference/orderly_run.html">orderly::orderly_run</a></code> repeatedly, which will be annoying - and impractical if the report is slow to run. So we can run instead:</p>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">orderly</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_develop_start.html">orderly_develop_start</a></span><span class="op">(</span><span class="st">"new"</span>, root <span class="op">=</span> <span class="va">path</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [ <span style="color: #5FAFD7; font-weight: bold;">name      </span> ]  new</span></span></code></pre>
<pre><code><span><span class="co">## [ <span style="color: #5FAFD7; font-weight: bold;">depends   </span> ]  example@20230621-105048-bd3a2cb5:mydata.csv -&gt; data.csv</span></span></code></pre>
<p>which copies in the required artefact and we can then change the directory (using something like <code>setwd("src/new")</code>) and start working on the report directly.</p>
<p>You can see the status of the directory by running</p>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">orderly</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_develop_start.html">orderly_develop_status</a></span><span class="op">(</span><span class="st">"new"</span>, root <span class="op">=</span> <span class="va">path</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##      filename       type present derived</span></span>
<span><span class="co">## 1 orderly.yml    orderly    TRUE   FALSE</span></span>
<span><span class="co">## 2    script.R     script    TRUE   FALSE</span></span>
<span><span class="co">## 3    data.csv dependency    TRUE    TRUE</span></span>
<span><span class="co">## 4    mean.txt   artefact   FALSE    TRUE</span></span></code></pre>
<p>(the output of this object is likely to change in future versions), which shows that <code>data.csv</code> is present, and that it is <em>derived</em> - by which means that orderly knows that it should not persist in the source tree. Files marked as <code>derived</code> as <code>TRUE</code> are liable for deletion by <code><a href="../reference/orderly_develop_start.html">orderly::orderly_develop_clean</a></code>. The output also shows that <code>mean.txt</code> is not present.</p>
<p>If you have changed directly into the path under development (via <code>setwd(file.path(path, "src/new"))</code>) the you can omit the arguments and simply call</p>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">orderly</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_develop_start.html">orderly_develop_status</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##      filename       type present derived</span></span>
<span><span class="co">## 1 orderly.yml    orderly    TRUE   FALSE</span></span>
<span><span class="co">## 2    script.R     script    TRUE   FALSE</span></span>
<span><span class="co">## 3    data.csv dependency    TRUE    TRUE</span></span>
<span><span class="co">## 4    mean.txt   artefact   FALSE    TRUE</span></span></code></pre>
<p>You can then run your script as if it was a normal R script:</p>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"script.R"</span>, echo <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## &gt; data &lt;- read.csv("data.csv")</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## &gt; writeLines(as.character(mean(data$y)), "mean.txt")</span></span></code></pre>
<p>(the above code assuming that we are within <code>src/new</code> with the report)</p>
<p>After which the <code>data.csv</code> is present</p>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">orderly</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_develop_start.html">orderly_develop_status</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##      filename       type present derived</span></span>
<span><span class="co">## 1 orderly.yml    orderly    TRUE   FALSE</span></span>
<span><span class="co">## 2    script.R     script    TRUE   FALSE</span></span>
<span><span class="co">## 3    data.csv dependency    TRUE    TRUE</span></span>
<span><span class="co">## 4    mean.txt   artefact    TRUE    TRUE</span></span></code></pre>
<p>If a newer version of the upstream dependency has become available, you can update the file by running <code><a href="../reference/orderly_develop_start.html">orderly::orderly_develop_start()</a></code> again</p>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu">orderly</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_run.html">orderly_run</a></span><span class="op">(</span><span class="st">"example"</span>, root <span class="op">=</span> <span class="va">path</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [ <span style="color: #5FAFD7; font-weight: bold;">name      </span> ]  example</span></span></code></pre>
<pre><code><span><span class="co">## [ <span style="color: #5FAFD7; font-weight: bold;">id        </span> ]  20230621-105050-7f4d9ff1</span></span></code></pre>
<pre><code><span><span class="co">## [ <span style="color: #5FAFD7; font-weight: bold;">start     </span> ]  2023-06-21 10:50:50</span></span></code></pre>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## &gt; dat &lt;- data.frame(x = 1:10, y = runif(10))</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## &gt; write.csv(dat, "mydata.csv", row.names = FALSE)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## &gt; png("mygraph.png")</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## &gt; plot(dat)</span></span></code></pre>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## &gt; dev.off()</span></span>
<span><span class="co">## agg_png </span></span>
<span><span class="co">##       2</span></span></code></pre>
<pre><code><span><span class="co">## [ <span style="color: #5FAFD7; font-weight: bold;">end       </span> ]  2023-06-21 10:50:50</span></span></code></pre>
<pre><code><span><span class="co">## [ <span style="color: #5FAFD7; font-weight: bold;">elapsed   </span> ]  Ran report in 0.01168251 secs</span></span></code></pre>
<pre><code><span><span class="co">## [ <span style="color: #5FAFD7; font-weight: bold;">artefact  </span> ]  mygraph.png: a9f715b3919f48edeaeea649d1693408</span></span>
<span><span class="co">## [ <span style="color: #5FAFD7; font-weight: bold;">...       </span> ]  mydata.csv: 9a8ea34959eb8172fd19dd78367d6cf9</span></span></code></pre>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">orderly</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_commit.html">orderly_commit</a></span><span class="op">(</span><span class="va">id</span>, root <span class="op">=</span> <span class="va">path</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [ <span style="color: #5FAFD7; font-weight: bold;">commit    </span> ]  example/20230621-105050-7f4d9ff1</span></span></code></pre>
<pre><code><span><span class="co">## [ <span style="color: #5FAFD7; font-weight: bold;">copy      </span> ]</span></span></code></pre>
<pre><code><span><span class="co">## [ <span style="color: #5FAFD7; font-weight: bold;">import    </span> ]  example:20230621-105050-7f4d9ff1</span></span></code></pre>
<pre><code><span><span class="co">## [ <span style="color: #5FAFD7; font-weight: bold;">success   </span> ]  :)</span></span></code></pre>
<pre><code><span><span class="co">## [1] "/tmp/RtmpzlBf1Y/file3597c1dbe0b/archive/example/20230621-105050-7f4d9ff1"</span></span></code></pre>
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">orderly</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_develop_start.html">orderly_develop_start</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [ <span style="color: #5FAFD7; font-weight: bold;">name      </span> ]  new</span></span></code></pre>
<pre><code><span><span class="co">## [ <span style="color: #5FAFD7; font-weight: bold;">depends   </span> ]  example@20230621-105050-7f4d9ff1:mydata.csv -&gt; data.csv</span></span></code></pre>
<p>(note that this has updated <code>data.csv</code> to use this new id 20230621-105050-7f4d9ff1).</p>
<p>Finally, you can delete the files that orderly has copied into the source tree:</p>
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">orderly</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_develop_start.html">orderly_develop_clean</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">## [ <span style="color: #5FAFD7; font-weight: bold;">remove    </span> ]  data.csv</span></span>
<span><span class="co">## [ <span style="color: #5FAFD7; font-weight: bold;">...       </span> ]  mean.txt</span></span>
<span><span class="fu">orderly</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_develop_start.html">orderly_develop_status</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">##      filename       type present derived</span></span>
<span><span class="co">## 1 orderly.yml    orderly    TRUE   FALSE</span></span>
<span><span class="co">## 2    script.R     script    TRUE   FALSE</span></span>
<span><span class="co">## 3    data.csv dependency   FALSE    TRUE</span></span>
<span><span class="co">## 4    mean.txt   artefact   FALSE    TRUE</span></span></code></pre></div>
<p>(this function also accepts <code>name</code> and <code>root</code> as above, required if not working in the source directory)</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Rich FitzJohn, Robert Ashton, Alex Hill, Martin Eden, Wes Hinsley, Emma Russell, James Thompson.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
